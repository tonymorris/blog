<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>λ Tony's blog λ - Automated Validation with Applicatives and Semigroups (for Sanjiv)</title>
  <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" type="text/css" href="../../css/screen.css" />
  <link rel="stylesheet" type="text/css" href="../../css/syntax.css" />
  <link rel="alternate" type="application/atom+xml" href="http://blog.tmorris.net/atom.xml" title="Atom feed" />
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/javascript" src="https://raw.github.com/Mathapedia/LaTeX2HTML5/master/latex2html5.min.js"></script>
</head>
<body>
<div id="title">
  λ Tony's blog λ
  <div id="subtitle">
    The weblog of Tony Morris
  </div>
</div>
<div id="header">
  <div id="navigation">
    <a class="navbar" href="../../index.html">Home</a>
    <a class="navbar" href="../../posts/">All Posts</a>
    <a class="navbar" href="../../contact/">Contact</a>
    <a class="navbar" href="http://cv.tmorris.net/">CV</a>
    <a class="navbar" href="../../atom.xml"><img src="../../images/feed-icon-14x14.png" alt="feed" /></a>
  </div>
</div>
<h1>Automated Validation with Applicatives and Semigroups (for Sanjiv)</h1>
<div class="info">Posted on March 21, 2010, in <a href="../../tags/Programming/index.html">Programming</a></div>

<p>Sanjiv is an ex-colleague of mine who recently gave an excellent presentation at <a href="http://www.meetup.com/Brisbane-Functional-Programming-Group-BFG/">Brisbane Functional Programming Group</a>. His presentation was on the use of the disjoint union algebraic data type for representing error handling or “validation”. This data type is often called <code>Either</code>. Sanjiv used <a href="http://www.scala-lang.org/docu/files/api/scala/Either.html">the Scala version</a> for his presentation.</p>
<p>Here I am going to write a data type that is just like (isomorphic to) <code>Either</code> called <code>Validation</code>. There will be two constructors for failure and success. I will be using Haskell, Scala and Java. I am going to present a function that is mentioned in an excellent paper called <a href="http://www.soi.city.ac.uk/~ross/papers/Applicative.html">Applicative Programming with Effects</a>.</p>
<p>There is a slight difference in my implementation to the function in this paper. The one mentioned in the paper uses a <code>Monoid</code> constraint, while I am using the more general <code>Semigroup</code>. This allows data types that are semigroups but not monoids (all monoids are semigroups). In particular, a non-empty list is a semigroup but not a monoid.</p>
<p>This constraint on the failing value allows the user to automatically accumulate errors as they chain through the <code>Validation</code> values, for example, by keeping them in a non-empty list. I am not going to give example usages of this code in this post because I think it is a great exercise for others and I do not want to spoil it. It is sufficient to say that any usage that type-checks is likely to be a useful example. I may give examples in the future if there is some confusion that needs clarification.</p>
<p>The function can accumulate <code>Validation</code> values using the applicative programming pattern. If all given are successful, you’ll be left with a function that takes all the successful values to a new value, which will be returned as a success. If at least one is not successful, the applicative pattern will begin accumulating with that error value and any future values.</p>
<p>I recommend starting with a simple example such as a <code>Person</code> type with an <code>age :: Int</code> and <code>name :: String</code> with imposed validation rules such as “age must be above 0 and less than 130” and “name must start with a capital letter”. The applied function at the end should be <code>ValidatedInt -&gt; ValidatedString -&gt; Person</code>.</p>
<p>Like I said, if there is any confusion, I’ll expand later. Put the questions in the comments. Enjoy! :)</p>
<p>Here is a Haskell implementation of this:</p>
<div class="sourceCode"><pre class="sourceCode Haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Validation</span> e a <span class="fu">=</span> <span class="dt">Fail</span> e <span class="fu">|</span> <span class="dt">Success</span> a <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)

<span class="co">-- Associative, binary operation (Monoid without identity)</span>
<span class="kw">class</span> <span class="dt">Semigroup</span> a <span class="kw">where</span>
<span class="ot">  append ::</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a

<span class="ot">(&lt;+&gt;) ::</span> <span class="dt">Validation</span> e a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Validation</span> e b
<span class="dt">Fail</span> e <span class="fu">&lt;+&gt;</span> _ <span class="fu">=</span> <span class="dt">Fail</span> e
<span class="dt">Success</span> a <span class="fu">&lt;+&gt;</span> f <span class="fu">=</span> <span class="dt">Success</span> (f a)

<span class="ot">(&lt;*&gt;) ::</span> (<span class="dt">Semigroup</span> e) <span class="ot">=&gt;</span> <span class="dt">Validation</span> e a
    <span class="ot">-&gt;</span> <span class="dt">Validation</span> e (a <span class="ot">-&gt;</span> b)
    <span class="ot">-&gt;</span> <span class="dt">Validation</span> e b
<span class="dt">Fail</span> e1 <span class="fu">&lt;*&gt;</span> <span class="dt">Fail</span> e2 <span class="fu">=</span> <span class="dt">Fail</span> (e1 <span class="ot">`append`</span> e2)
<span class="dt">Fail</span> e1 <span class="fu">&lt;*&gt;</span> <span class="dt">Success</span> _ <span class="fu">=</span> <span class="dt">Fail</span> e1
<span class="dt">Success</span> _ <span class="fu">&lt;*&gt;</span> <span class="dt">Fail</span> e2 <span class="fu">=</span> <span class="dt">Fail</span> e2
<span class="dt">Success</span> a <span class="fu">&lt;*&gt;</span> <span class="dt">Success</span> f <span class="fu">=</span> <span class="dt">Success</span> (f a)</code></pre></div>
<p>And Scala:</p>
<div class="sourceCode"><pre class="sourceCode Scala"><code class="sourceCode scala"><span class="kw">sealed</span> <span class="kw">trait</span> Validation[E, A] {
  <span class="kw">def</span> &lt;+&gt;[B](f: A =&gt; B): Validation[E, B] = <span class="kw">this</span> <span class="kw">match</span> {
    <span class="kw">case</span> <span class="fu">Fail</span>(e) =&gt; <span class="fu">Fail</span>(e)
    <span class="kw">case</span> <span class="fu">Success</span>(a) =&gt; <span class="fu">Success</span>(<span class="fu">f</span>(a))
  }

  <span class="kw">def</span> &lt;*&gt;[B](f: Validation[E, A =&gt; B])(<span class="kw">implicit</span> s: Semigroup[E])
    : Validation[E, B] = <span class="kw">this</span> <span class="kw">match</span> {
    <span class="kw">case</span> <span class="fu">Fail</span>(e1) =&gt; f <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Fail</span>(e2) =&gt; <span class="fu">Fail</span>(s <span class="fu">append</span> (e1, e2))
      <span class="kw">case</span> <span class="fu">Success</span>(_) =&gt; <span class="fu">Fail</span>(e1)
    }
    <span class="kw">case</span> <span class="fu">Success</span>(a) =&gt; f <span class="kw">match</span> {
      <span class="kw">case</span> <span class="fu">Fail</span>(e2) =&gt; <span class="fu">Fail</span>(e2)
      <span class="kw">case</span> <span class="fu">Success</span>(f) =&gt; <span class="fu">Success</span>(<span class="fu">f</span>(a))
    }
  }
}
<span class="kw">case</span> <span class="kw">class</span> Fail[E, A](e: E) <span class="kw">extends</span> Validation[E, A]
<span class="kw">case</span> <span class="kw">class</span> Success[E, A](a: A) <span class="kw">extends</span> Validation[E, A]

<span class="co">// Associative binary operation (Monoid without identity)</span>
<span class="kw">case</span> <span class="kw">class</span> Semigroup[A](append: (A, A) =&gt; A)</code></pre></div>
<p>And now, for the allegedly practical Java. Hold your breath:</p>
<div class="sourceCode"><pre class="sourceCode Java"><code class="sourceCode java"><span class="co">// Java pre-amble, sigh.</span>
<span class="kw">interface</span> F&lt;X, Y&gt; {
  Y <span class="fu">apply</span>(X x);
}

<span class="co">// Associative binary operation (Monoid without identity)</span>
<span class="kw">interface</span> Semigroup&lt;a&gt; {
  A <span class="fu">append</span>(A a1, A a2);
}

<span class="kw">abstract</span> <span class="kw">class</span> Validation&lt;E, A&gt; {
  <span class="co">// No algebraic data types in Java. Use a Church encoding (catamorphism).</span>
  <span class="kw">public</span> <span class="kw">abstract</span> &lt;x&gt; X <span class="fu">fold</span>(F&lt;E, X&gt; fail, F&lt;A, X&gt; success);

  <span class="co">// Construction for fail</span>
  <span class="kw">public</span> <span class="dt">static</span> &lt;E, A&gt; Validation&lt;E, A&gt; <span class="fu">fail</span>(<span class="dt">final</span> E e) {
    <span class="kw">return</span> <span class="kw">new</span> Validation&lt;E, A&gt;() {
      <span class="kw">public</span> &lt;x&gt; X <span class="fu">fold</span>(<span class="dt">final</span> F&lt;E, X&gt; fail, <span class="dt">final</span> F&lt;A, X&gt; success) {
        <span class="kw">return</span> fail.<span class="fu">apply</span>(e);
      }
    };
  }

  <span class="co">// Construction for success</span>
  <span class="kw">public</span> <span class="dt">static</span> &lt;E, A&gt; Validation&lt;E, A&gt; <span class="fu">success</span>(<span class="dt">final</span> A a) {
    <span class="kw">return</span> <span class="kw">new</span> Validation&lt;E, A&gt;() {
      <span class="kw">public</span> &lt;x&gt; X <span class="fu">fold</span>(<span class="dt">final</span> F&lt;E, X&gt; fail, <span class="dt">final</span> F&lt;A, X&gt; success) {
        <span class="kw">return</span> success.<span class="fu">apply</span>(a);
      }
    };
  }

  <span class="co">// &lt;+&gt;</span>
  <span class="kw">public</span> &lt;b&gt; Validation&lt;E, B&gt; <span class="fu">map</span>(<span class="dt">final</span> F&lt;A, B&gt; f) {
    <span class="kw">return</span> <span class="kw">new</span> Validation&lt;E, B&gt;() {
      <span class="kw">public</span> &lt;x&gt; X <span class="fu">fold</span>(<span class="dt">final</span> F&lt;E, X&gt; fail, <span class="dt">final</span> F&lt;B, X&gt; success) {
        <span class="kw">return</span> Validation.<span class="fu">this</span>.<span class="fu">fold</span>(fail, <span class="kw">new</span> F&lt;A, X&gt;() {
          <span class="kw">public</span> X <span class="fu">apply</span>(<span class="dt">final</span> A a) {
            <span class="kw">return</span> success.<span class="fu">apply</span>(f.<span class="fu">apply</span>(a));
          }
        });
      }
    };
  }

  <span class="co">// &lt;*&gt;</span>
  <span class="kw">public</span> &lt;b&gt; Validation&lt;E, B&gt; <span class="fu">applicativate</span>(
      <span class="dt">final</span> Validation&lt;E, F&lt;A, B&gt;&gt; f,
      <span class="dt">final</span> Semigroup&lt;e&gt; s <span class="co">/* no implicits or type-classes in Java */</span>) {
    <span class="kw">return</span> Validation.<span class="fu">this</span>.<span class="fu">fold</span>(<span class="kw">new</span> F&lt;E, Validation&lt;E, B&gt;&gt;() {
      <span class="kw">public</span> Validation&lt;E, B&gt; <span class="fu">apply</span>(<span class="dt">final</span> E e1) {
        <span class="kw">return</span> f.<span class="fu">fold</span>(<span class="kw">new</span> F&lt;E, Validation&lt;E, B&gt;&gt;() {
          <span class="kw">public</span> Validation&lt;E, B&gt; <span class="fu">apply</span>(<span class="dt">final</span> E e2) {
            <span class="co">// case (Fail(e1), Fail(e2))</span>
            <span class="kw">return</span> Validation.<span class="fu">fail</span>(s.<span class="fu">append</span>(e1, e2));
          }
        }, <span class="kw">new</span> F&lt;F&lt;A, B&gt;, Validation&lt;E, B&gt;&gt;() {
          <span class="kw">public</span> Validation&lt;E, B&gt; <span class="fu">apply</span>(<span class="dt">final</span> F&lt;A, B&gt; f) {
            <span class="co">// case (Fail(e1), Success(f))</span>
            <span class="kw">return</span> Validation.<span class="fu">fail</span>(e1);
          }
        });
      }
    }, <span class="kw">new</span> F&lt;A, Validation&lt;E, B&gt;&gt;() {
      <span class="kw">public</span> Validation&lt;E, B&gt; <span class="fu">apply</span>(<span class="dt">final</span> A a) {
        <span class="kw">return</span> f.<span class="fu">fold</span>(<span class="kw">new</span> F&lt;E, Validation&lt;E, B&gt;&gt;() {
          <span class="kw">public</span> Validation&lt;E, B&gt; <span class="fu">apply</span>(<span class="dt">final</span> E e2) {
            <span class="co">// case (Success(a), Fail(e2))</span>
            <span class="kw">return</span> Validation.<span class="fu">fail</span>(e2);
          }
        }, <span class="kw">new</span> F&lt;F&lt;A, B&gt;, Validation&lt;E, B&gt;&gt;() {
          <span class="kw">public</span> Validation&lt;E, B&gt; <span class="fu">apply</span>(<span class="dt">final</span> F&lt;A, B&gt; f) {
            <span class="co">// case (Success(a), Success(f))</span>
            <span class="kw">return</span> Validation.<span class="fu">success</span>(f.<span class="fu">apply</span>(a));
          }
        });
      }
    });
  }
}</code></pre></div>


<hr />
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'tonys--blog';
  var discus_identifier = '/posts/automated-validation-with-applicatives-and-semigroups-for-sanjiv/index.html';
  var disqus_url = 'http://blog.tmorris.net/posts/automated-validation-with-applicatives-and-semigroups-for-sanjiv/index.html';
  var discus_title = 'Automated Validation with Applicatives and Semigroups (for Sanjiv)';
  (function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript><p>The comments use <a href="http://disqus.com/?ref_noscript">Disqus</a>,
  which requires Javascript.</p></noscript>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3405112-1']);
  _gaq.push(['_trackPageview']);
  (function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
